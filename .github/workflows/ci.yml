name: ci
on: [push]
jobs:
  install-ubuntu:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ocaml-compiler:
          - 4.13.x
          - 4.14.x
        additional-packages:
          -
          - labltk
    steps:
      - uses: actions/checkout@v3
      - uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: ${{ matrix.ocaml-compiler }}
      - run: sudo apt-get update
      - run: >
          sudo apt-get install --yes gnuplot-nox
          poppler-utils graphviz texlive-latex-recommended
          texlive-fonts-recommended texlive-pictures tex4ht
          texlive-latex-extra
      - run: >
          opam depext --install --yes dune num yojson lwt fmt logs re
          odoc lwt_react tyxml-ppx js_of_ocaml-lwt
          js_of_ocaml-tyxml camlp-streams ${{ matrix.additional-packages }}
      - run: opam exec -- make all
      - run: opam exec -- make doc_html
      - run: opam exec -- make --jobs=2 check

  python:
    strategy:
      fail-fast: false
      matrix:
        additional-packages:
          - atdgen
          - atdgen.2.2.1
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: 4.13.x
      - run: sudo apt-get update
      - run: >
          sudo apt-get install --yes gnuplot-nox
          poppler-utils graphviz texlive-latex-recommended
          texlive-fonts-recommended texlive-pictures tex4ht
      - run: >
          opam install --yes dune num yojson lwt fmt logs re
          cohttp-lwt-unix ${{ matrix.additional-packages }}
      - run: pip install nose
      - run: opam exec -- make all
      - run: opam exec -- dune build
      - run: opam exec -- nosetests -v tests/kappy

  js:
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest
        additional-packages:
          - atdgen
          - atdgen.2.2.1
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: 4.13.x
      - run: >
          sudo apt-get update

          sudo apt-get install --yes gnuplot-nox
          poppler-utils graphviz texlive-latex-recommended
          texlive-fonts-recommended texlive-pictures tex4ht
        if: matrix.os == 'ubuntu-latest'
      - run: >
          opam install --yes dune num yojson lwt fmt logs re
          lwt_react tyxml-ppx js_of_ocaml-lwt
          js_of_ocaml-tyxml ${{ matrix.additional-packages }}
      - run: opam exec -- make all
      - run: opam exec -- make Kappapp.tar.gz site/index.html
        if: matrix.os == 'ubuntu-latest'
      - run: opam exec -- make Kappapp.app
        if: matrix.os == 'macos-latest'
      - run: opam exec -- make KappaBin.zip
        if: matrix.os == 'windows-latest'
